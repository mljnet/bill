<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setting Isolir - Admin Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
        }
        
        .suspension-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .stats-card {
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .btn-suspend {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            border: none;
            border-radius: 8px;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-restore {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
            border-radius: 8px;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-check {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: white;
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <%- include('../../partials/billing-sidebar') %>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="bx bx-block"></i> Setting Isolir
                    </h1>
                </div>

                <!-- Setting Isolir Overview -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="suspension-card p-4">
                            <h4><i class="bx bx-shield-x me-2"></i>Kelola Setting Isolir</h4>
                            <p class="mb-0">Sistem otomatis untuk menonaktifkan layanan pelanggan yang telat bayar menggunakan profile isolir Mikrotik dan mengaktifkan kembali setelah pembayaran.</p>
                        </div>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <i class="bx bx-user-check text-primary" style="font-size: 2rem;"></i>
                                <h3 class="text-primary" id="activeCustomers">-</h3>
                                <p class="text-muted mb-0">Pelanggan Aktif</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <i class="bx bx-pause-circle text-danger" style="font-size: 2rem;"></i>
                                <h3 class="text-danger" id="suspendedCustomers">-</h3>
                                <p class="text-muted mb-0">Pelanggan Suspended</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <i class="bx bx-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                                <h3 class="text-warning" id="overdueInvoices">-</h3>
                                <p class="text-muted mb-0">Tagihan Overdue</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <i class="bx bx-time text-info" style="font-size: 2rem;"></i>
                                <h3 class="text-info" id="gracePeriod"><%= appSettings.suspension_grace_period_days || '7' %></h3>
                                <p class="text-muted mb-0">Tambahan Waktu (Hari)</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Isolir Profile Setting -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <strong>Pilih Profile Isolir (Mikrotik)</strong>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary me-2" id="reloadIsolirProfilesBtn">
                                        <i class="bx bx-refresh me-1"></i>Reload
                                    </button>
                                    <button class="btn btn-sm btn-primary" id="saveIsolirProfileBtn">
                                        <i class="bx bx-save me-1"></i>Simpan
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <label for="isolirProfileSelect" class="form-label">Profile Isolir</label>
                                <select id="isolirProfileSelect" class="form-select">
                                    <option value="default">Loading...</option>
                                </select>
                                <small class="text-muted">Dipakai saat Suspend. Current: <%= appSettings.isolir_profile || 'isolir' %></small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <strong>Tambahan Waktu Setelah Jatuh Tempo</strong>
                                <button class="btn btn-sm btn-primary" id="saveGracePeriodBtn">
                                    <i class="bx bx-save me-1"></i>Simpan
                                </button>
                            </div>
                            <div class="card-body">
                                <label for="gracePeriodInput" class="form-label">Tambahan Waktu (Hari)</label>
                                <input type="number" id="gracePeriodInput" class="form-control" 
                                       value="<%= appSettings.suspension_grace_period_days || '7' %>" 
                                       min="1" max="30" placeholder="Masukkan jumlah hari">
                                <small class="text-muted">Berapa hari tambahan setelah jatuh tempo sebelum diisolir otomatis. Current: <%= appSettings.suspension_grace_period_days || '7' %> hari</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bandwidth Limit Setting -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <strong>Bandwidth Limit Isolir</strong>
                                <button class="btn btn-sm btn-primary" id="saveBandwidthLimitBtn">
                                    <i class="bx bx-save me-1"></i>Simpan
                                </button>
                            </div>
                            <div class="card-body">
                                <label for="bandwidthLimitInput" class="form-label">Bandwidth Limit</label>
                                <input type="text" id="bandwidthLimitInput" class="form-control" 
                                       value="<%= appSettings.suspension_bandwidth_limit || '1k/1k' %>" 
                                       placeholder="Contoh: 1k/1k, 512k/512k">
                                <small class="text-muted">Batas bandwidth untuk pelanggan yang diisolir. Current: <%= appSettings.suspension_bandwidth_limit || '1k/1k' %></small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <strong>Metode Suspend IP Statis</strong>
                                <button class="btn btn-sm btn-primary" id="saveSuspensionMethodBtn">
                                    <i class="bx bx-save me-1"></i>Simpan
                                </button>
                            </div>
                            <div class="card-body">
                                <label for="suspensionMethodSelect" class="form-label">Metode Suspend</label>
                                <select id="suspensionMethodSelect" class="form-select">
                                    <option value="address_list" <%= (appSettings.static_ip_suspension_method || 'address_list') === 'address_list' ? 'selected' : '' %>>Address List (Recommended)</option>
                                    <option value="disable" <%= (appSettings.static_ip_suspension_method || 'address_list') === 'disable' ? 'selected' : '' %>>Disable Interface</option>
                                </select>
                                <small class="text-muted">Metode untuk suspend pelanggan IP statis. Current: <%= appSettings.static_ip_suspension_method || 'address_list' %></small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="bx bx-search text-warning" style="font-size: 3rem;"></i>
                                <h5>Cek Pelanggan Overdue</h5>
                                <p class="text-muted">Periksa dan suspend pelanggan yang telat bayar</p>
                                <button class="btn btn-check w-100" id="checkOverdueBtn">
                                    <i class="bx bx-search me-2"></i>Cek & Suspend Overdue
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="bx bx-check-circle text-success" style="font-size: 3rem;"></i>
                                <h5>Restore Pelanggan Bayar</h5>
                                <p class="text-muted">Aktifkan kembali pelanggan yang sudah bayar</p>
                                <button class="btn btn-restore w-100" id="checkPaidBtn">
                                    <i class="bx bx-check me-2"></i>Cek & Restore Paid
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="bx bx-refresh text-primary" style="font-size: 3rem;"></i>
                                <h5>Refresh Statistics</h5>
                                <p class="text-muted">Perbarui statistik terbaru</p>
                                <button class="btn btn-check w-100" id="refreshStatsBtn">
                                    <i class="bx bx-refresh me-2"></i>Refresh Stats
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Suspended Customers Table -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bx bx-pause-circle me-2"></i>Pelanggan Suspended</h5>
                                <button class="btn btn-sm btn-outline-primary" id="refreshTableBtn">
                                    <i class="bx bx-refresh me-1"></i>Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="suspendedTable">
                                        <thead>
                                            <tr>
                                                <th>Username</th>
                                                <th>Nama</th>
                                                <th>Phone</th>
                                                <th>Paket</th>
                                                <th>Status</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="6" class="text-center">Loading...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <script>
        // Toast function
        function showToast(type, title, message) {
            const toastId = 'toast-' + Date.now();
            const iconMap = {
                success: 'bx bx-check-circle',
                error: 'bx bx-x-circle',
                warning: 'bx bx-exclamation-triangle',
                info: 'bx bx-info-circle'
            };

            const toastHtml = `
                <div id="${toastId}" class="toast ${type}" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="5000">
                    <div class="toast-header">
                        <i class="${iconMap[type]} me-2"></i>
                        <strong class="me-auto">${title}</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">${message}</div>
                </div>
            `;

            $('#toast-container').append(toastHtml);
            new bootstrap.Toast(document.getElementById(toastId)).show();

            setTimeout(() => {
                $(`#${toastId}`).remove();
            }, 6000);
        }

        // Load statistics
        function loadStats() {
            $.get('/admin/billing/api/stats', function(response) {
                const stats = response.data || response;
                $('#activeCustomers').text(stats.active_customers || 0);
            }).fail(() => {
                $('#activeCustomers').text('Error');
            });

            $.get('/admin/billing/api/customers', function(response) {
                const customers = response.customers || response;
                const suspended = customers.filter(c => c.status === 'suspended').length;
                $('#suspendedCustomers').text(suspended);
            }).fail(() => {
                $('#suspendedCustomers').text('Error');
            });

            $.get('/admin/billing/api/overdue', function(overdue) {
                $('#overdueInvoices').text(overdue.length);
            }).fail(() => {
                $('#overdueInvoices').text('Error');
            });
        }

        // Load suspended customers table
        function loadSuspendedCustomers() {
            $.get('/admin/billing/api/customers', function(response) {
                const customers = response.customers || response;
                const suspended = customers.filter(c => c.status === 'suspended');
                const tbody = $('#suspendedTable tbody');
                tbody.empty();

                if (suspended.length === 0) {
                    tbody.append('<tr><td colspan="6" class="text-center text-muted">Tidak ada pelanggan yang suspended</td></tr>');
                    return;
                }

                suspended.forEach(customer => {
                    const row = `
                        <tr>
                            <td>${customer.username}</td>
                            <td>${customer.name}</td>
                            <td>${customer.phone || '-'}</td>
                            <td>${customer.package_name || '-'}</td>
                            <td><span class="badge bg-danger">Suspended</span></td>
                            <td>
                                <button class="btn btn-sm btn-restore" onclick="restoreCustomer('${customer.username}')">
                                    <i class="bx bx-check me-1"></i>Restore
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            }).fail(() => {
                $('#suspendedTable tbody').html('<tr><td colspan="6" class="text-center text-danger">Error loading data</td></tr>');
            });
        }

        // Check overdue customers
        $('#checkOverdueBtn').click(function() {
            const btn = $(this);
            btn.prop('disabled', true).html('<i class="bx bx-loader-alt bx-spin me-2"></i>Checking...');

            $.post('/admin/billing/service-suspension/check-overdue', function(response) {
                if (response.success) {
                    const message = `Checked: ${response.checked || 0}, Suspended: ${response.suspended || 0}, Errors: ${response.errors || 0}`;
                    showToast('success', 'Check Overdue Complete', message);
                    loadStats();
                    loadSuspendedCustomers();
                } else {
                    showToast('error', 'Error', response.message || 'Unknown error occurred');
                }
            }).fail(function(xhr) {
                const response = xhr.responseJSON || {};
                showToast('error', 'Error', response.message || 'Request failed');
            }).always(function() {
                btn.prop('disabled', false).html('<i class="bx bx-search me-2"></i>Cek & Suspend Overdue');
            });
        });

        // Check paid customers
        $('#checkPaidBtn').click(function() {
            const btn = $(this);
            btn.prop('disabled', true).html('<i class="bx bx-loader-alt bx-spin me-2"></i>Checking...');

            $.post('/admin/billing/service-suspension/check-paid', function(response) {
                if (response.success) {
                    const message = `Checked: ${response.checked || 0}, Restored: ${response.restored || 0}, Errors: ${response.errors || 0}`;
                    showToast('success', 'Check Paid Complete', message);
                    loadStats();
                    loadSuspendedCustomers();
                } else {
                    showToast('error', 'Error', response.message || 'Unknown error occurred');
                }
            }).fail(function(xhr) {
                const response = xhr.responseJSON || {};
                showToast('error', 'Error', response.message || 'Request failed');
            }).always(function() {
                btn.prop('disabled', false).html('<i class="bx bx-check me-2"></i>Cek & Restore Paid');
            });
        });

        // Refresh stats
        $('#refreshStatsBtn').click(function() {
            const btn = $(this);
            btn.prop('disabled', true).html('<i class="bx bx-loader-alt bx-spin me-2"></i>Loading...');
            
            loadStats();
            
            setTimeout(() => {
                btn.prop('disabled', false).html('<i class="bx bx-refresh me-2"></i>Refresh Stats');
                showToast('success', 'Refreshed', 'Statistics updated');
            }, 1000);
        });

        // Refresh table
        $('#refreshTableBtn').click(function() {
            loadSuspendedCustomers();
            showToast('info', 'Refreshed', 'Table updated');
        });

        // Restore customer
        function restoreCustomer(username) {
            if (!username || username.trim() === '') {
                showToast('error', 'Error', 'Username tidak valid');
                return;
            }

            if (!confirm(`Yakin ingin restore layanan untuk pelanggan ${username}?`)) return;

            const reason = prompt('Masukkan alasan buka isolir (opsional):', 'Manual restore');
            if (reason === null) return; // user canceled prompt

            // Show loading state
            showToast('info', 'Processing', `Sedang mengaktifkan layanan ${username}...`);

            $.post(`/admin/billing/service-suspension/restore/${username}`, { reason }, function(response) {
                if (response.success) {
                    const r = (response.reason || reason || '').trim();
                    const msg = r ? `Layanan ${username} diaktifkan. Alasan: ${r}` : `Layanan ${username} berhasil diaktifkan`;
                    showToast('success', 'Service Restored', msg);
                    loadStats();
                    loadSuspendedCustomers();
                } else {
                    showToast('error', 'Error', response.message || 'Gagal mengaktifkan layanan');
                }
            }).fail(function(xhr) {
                const response = xhr.responseJSON || {};
                showToast('error', 'Error', response.message || 'Request failed');
            });
        }

        // Initialize
        $(document).ready(function() {
            // Load current setting first, then load profiles with that value
            loadCurrentIsolirProfile();
            loadStats();
            loadSuspendedCustomers();
            
            // Setup new form handlers
            setupBandwidthLimitHandler();
            setupSuspensionMethodHandler();
        });

        // Load Mikrotik PPPoE profiles into isolir select
        function loadIsolirProfiles(selected) {
            const sel = document.getElementById('isolirProfileSelect');
            if (!sel) return;
            sel.innerHTML = '<option>Loading...</option>';
            fetch('/admin/mikrotik/profiles/api')
                .then(r => r.json())
                .then(data => {
                    const names = Array.from(new Set(((data && data.profiles) || []).map(p => p.name).filter(Boolean)));
                    if (!names.includes('isolir')) names.unshift('isolir');
                    sel.innerHTML = '';
                    names.forEach(n => {
                        const opt = document.createElement('option');
                        opt.value = n;
                        opt.textContent = n;
                        sel.appendChild(opt);
                    });
                    // Set selected value after options are loaded
                    if (selected) {
                        sel.value = selected;
                        // If value doesn't exist, add it
                        if (sel.value !== selected) {
                            const opt = document.createElement('option');
                            opt.value = selected;
                            opt.textContent = selected;
                            sel.appendChild(opt);
                            sel.value = selected;
                        }
                    }
                })
                .catch(err => {
                    console.error('Load isolir profiles error:', err);
                    sel.innerHTML = '<option value="isolir">isolir</option>';
                    if (selected && selected !== 'isolir') {
                        const opt = document.createElement('option');
                        opt.value = selected;
                        opt.textContent = selected;
                        sel.appendChild(opt);
                        sel.value = selected;
                    }
                    showToast('error', 'Gagal', 'Gagal memuat profile Mikrotik');
                });
        }

        // Setup Bandwidth Limit Handler
        function setupBandwidthLimitHandler() {
            $('#saveBandwidthLimitBtn').click(function(){
                const value = $('#bandwidthLimitInput').val().trim();
                if (!value) {
                    showToast('error', 'Gagal', 'Bandwidth limit tidak boleh kosong');
                    return;
                }
                
                const btn = $(this);
                btn.prop('disabled', true).html('<i class="bx bx-loader-alt bx-spin me-1"></i>Menyimpan...');
                fetch('/admin/billing/service-suspension/bandwidth-limit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
                    body: new URLSearchParams({ suspension_bandwidth_limit: value }).toString()
                }).then(r => r.json()).then(data => {
                    if (data && data.success) {
                        showToast('success', 'Tersimpan', `Bandwidth limit diset ke: ${value}`);
                    } else {
                        showToast('error', 'Gagal', data.message || 'Gagal menyimpan');
                    }
                }).catch(err => {
                    showToast('error', 'Gagal', 'Gagal menyimpan');
                }).finally(() => {
                    btn.prop('disabled', false).html('<i class="bx bx-save me-1"></i>Simpan');
                });
            });
        }

        // Setup Suspension Method Handler
        function setupSuspensionMethodHandler() {
            $('#saveSuspensionMethodBtn').click(function(){
                const value = $('#suspensionMethodSelect').val();
                if (!value) {
                    showToast('error', 'Gagal', 'Metode suspend tidak boleh kosong');
                    return;
                }
                
                const btn = $(this);
                btn.prop('disabled', true).html('<i class="bx bx-loader-alt bx-spin me-1"></i>Menyimpan...');
                fetch('/admin/billing/service-suspension/suspension-method', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
                    body: new URLSearchParams({ static_ip_suspension_method: value }).toString()
                }).then(r => r.json()).then(data => {
                    if (data && data.success) {
                        showToast('success', 'Tersimpan', `Metode suspend diset ke: ${value}`);
                    } else {
                        showToast('error', 'Gagal', data.message || 'Gagal menyimpan');
                    }
                }).catch(err => {
                    showToast('error', 'Gagal', 'Gagal menyimpan');
                }).finally(() => {
                    btn.prop('disabled', false).html('<i class="bx bx-save me-1"></i>Simpan');
                });
            });
        }

        // Get current isolir profile setting
        function loadCurrentIsolirProfile() {
            fetch('/admin/billing/service-suspension/isolir-profile')
                .then(r => r.json())
                .then(data => {
                    if (data && data.success) {
                        const current = data.isolir_profile || 'isolir';
                        // Load profiles with current value selected
                        loadIsolirProfiles(current);
                        // tandai siap agar change berikutnya dianggap aksi user
                        isolirSelectReady = true;
                    } else {
                        // Fallback jika gagal ambil setting
                        loadIsolirProfiles('isolir');
                        isolirSelectReady = true;
                    }
                })
                .catch(() => {
                    // Fallback jika gagal ambil setting
                    loadIsolirProfiles('isolir');
                    isolirSelectReady = true;
                });
        }

        // Save isolir profile
        $('#saveIsolirProfileBtn').click(function(){
            const sel = document.getElementById('isolirProfileSelect');
            if (!sel) return;
            const value = sel.value || 'isolir';
            const btn = $(this);
            btn.prop('disabled', true).html('<i class="bx bx-loader-alt bx-spin me-1"></i>Menyimpan...');
            fetch('/admin/billing/service-suspension/isolir-profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
                body: new URLSearchParams({ isolir_profile: value }).toString()
            }).then(r => r.json()).then(data => {
                if (data && data.success) {
                    showToast('success', 'Tersimpan', `Isolir profile diset ke: ${value}`);
                } else {
                    showToast('error', 'Gagal', data.message || 'Gagal menyimpan');
                }
            }).catch(err => {
                showToast('error', 'Gagal', 'Gagal menyimpan');
            }).finally(() => {
                btn.prop('disabled', false).html('<i class="bx bx-save me-1"></i>Simpan');
            });
        });

        // Save grace period
        $('#saveGracePeriodBtn').click(function(){
            const input = document.getElementById('gracePeriodInput');
            if (!input) return;
            const value = parseInt(input.value) || 7;
            if (value < 1 || value > 30) {
                showToast('error', 'Error', 'Tambahan waktu harus antara 1-30 hari');
                return;
            }
            const btn = $(this);
            btn.prop('disabled', true).html('<i class="bx bx-loader-alt bx-spin me-1"></i>Menyimpan...');
            fetch('/admin/billing/service-suspension/grace-period', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
                body: new URLSearchParams({ suspension_grace_period_days: value.toString() }).toString()
            }).then(r => r.json()).then(data => {
                if (data && data.success) {
                    showToast('success', 'Tersimpan', `Tambahan waktu diset ke: ${value} hari`);
                    // Update stats card
                    $('#gracePeriod').text(value);
                } else {
                    showToast('error', 'Gagal', data.message || 'Gagal menyimpan');
                }
            }).catch(err => {
                showToast('error', 'Gagal', 'Gagal menyimpan');
            }).finally(() => {
                btn.prop('disabled', false).html('<i class="bx bx-save me-1"></i>Simpan');
            });
        });

        // Autosave saat pilihan profil berubah
        let isolirSelectReady = false;
        $(document).on('change', '#isolirProfileSelect', function(){
            if (!isolirSelectReady) return; // hindari trigger saat inisialisasi
            const value = this.value || 'isolir';
            fetch('/admin/billing/service-suspension/isolir-profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
                body: new URLSearchParams({ isolir_profile: value }).toString()
            }).then(r => r.json()).then(data => {
                if (data && data.success) {
                    showToast('success', 'Tersimpan', `Isolir profile diset ke: ${value}`);
                } else {
                    showToast('error', 'Gagal', data.message || 'Gagal menyimpan');
                }
            }).catch(() => {
                showToast('error', 'Gagal', 'Gagal menyimpan');
            });
        });

        // Reload profiles button
        $('#reloadIsolirProfilesBtn').click(function(){
            // Ambil nilai terkini dari settings.json lalu reload profiles dengan pilihan itu
            fetch('/admin/billing/service-suspension/isolir-profile')
                .then(r => r.json())
                .then(data => {
                    const current = (data && data.success && data.isolir_profile) ? data.isolir_profile : (document.getElementById('isolirProfileSelect')?.value || 'isolir');
                    loadIsolirProfiles(current);
                    // Setelah memuat, paksa set value ke current jika perlu
                    setTimeout(() => {
                        const sel = document.getElementById('isolirProfileSelect');
                        if (sel) {
                            sel.value = current;
                            if (sel.value !== current) {
                                const opt = document.createElement('option');
                                opt.value = current;
                                opt.textContent = current;
                                sel.appendChild(opt);
                                sel.value = current;
                            }
                        }
                    }, 300);
                })
                .catch(() => {
                    const current = document.getElementById('isolirProfileSelect')?.value;
                    loadIsolirProfiles(current);
                });
        });
    </script>
</body>
</html>
